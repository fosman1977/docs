---
title: "AI Integration (Claude & OpenAI)"
description: "AI architecture powering intelligent features across the platform"
---

The Chambers Platform uses **Anthropic Claude** as the primary AI provider for strategic business intelligence, with OpenAI available for specific high-volume operations.

## Overview

| Feature | AI Provider | Model | Reason |
|---------|-------------|-------|--------|
| Chamber Insights | **Claude (Anthropic)** | Claude Sonnet 4 | Superior reasoning for strategic analysis |
| Daily Insights (Cron) | **Claude (Anthropic)** | Claude Sonnet 4 | Consistent trajectory analysis |
| Natural Language Queries | **Claude (Anthropic)** | Claude Sonnet 4 | Complex question answering |
| Lead Suggestions | **OpenAI** | GPT-4o-mini | Cost-effective matching |
| Opportunity Suggestions | **OpenAI** | GPT-4o-mini | Fast recommendations |

<Note>
As of January 2025, all strategic analytics endpoints have been consolidated to use Claude for consistency. This ensures trajectory analysis and time-of-year context is applied uniformly across all insights.
</Note>

## Implementation Architecture

<Note>
All strategic insights endpoints now use Claude for consistency. The legacy OpenAI implementation is retained for benchmarking purposes but is not active in production.
</Note>

### Active Services

| Service File | Provider | Status |
|--------------|----------|--------|
| `chambers-insights-claude.service.server.ts` | Claude Sonnet 4 | **Active** - All insights |
| `chambers-prompts-claude.ts` | Claude Sonnet 4 | **Active** - Prompt templates with trajectory analysis |
| `suggestion-engine.server.ts` | OpenAI GPT-4o-mini | Active - Lead suggestions |

### Legacy Services (Not Active)

| Service File | Provider | Status |
|--------------|----------|--------|
| `chambers-insights.service.server.ts` | OpenAI GPT-4o-mini | Legacy (benchmarking only) |
| `chambers-prompts.ts` | OpenAI GPT-4o-mini | Legacy (benchmarking only) |

## Package Versions

| Package | Version | Purpose |
|---------|---------|---------|
| `@anthropic-ai/sdk` | 0.71.0 | Claude API client |
| `openai` | 4.24.7 | OpenAI API client |

## Authentication

### Required API Keys

Both API keys are required for full AI functionality:

```bash
# Anthropic (Claude) - Required for Chamber Insights
ANTHROPIC_API_KEY=sk-ant-...

# OpenAI - Required for Lead Suggestions and Analytics
OPENAI_API_KEY=sk-...
```

<Warning>
Store both API keys in environment variables. Never commit to source code.
</Warning>

## Claude-Powered Features

### Chamber Insights (`/api/ai/chambers-insights`)

The flagship AI feature uses Claude Sonnet 4 for strategic business analysis.

**Why Claude?**

- Superior reasoning for complex financial analysis
- Better at synthesising multiple data sources
- More nuanced strategic recommendations
- GDPR-compliant data handling

**Capabilities:**

- Financial risk analysis with severity scoring
- Performance trend identification with **trajectory analysis**
- Opportunity discovery
- Executive summaries
- Web-enhanced industry context
- **Time-of-year target assessment**

### Trajectory Analysis (New)

All Claude-powered insights now include **trajectory analysis** - comparing current progress against where barristers/chambers should be at this point in the financial year.

**How It Works:**

1. **Pro-rata calculation**: At month 6, barristers should have achieved ~50% of their annual target
2. **Gap analysis**: Compare actual progress vs expected pro-rata position
3. **Status classification**:
   - **AHEAD**: Current % > Expected % + 5%
   - **ON TRACK**: Current % within ±5% of expected
   - **BEHIND PACE**: Current % < Expected % - 5%
   - **SIGNIFICANTLY BEHIND**: Current % < Expected % - 15%

**Example:**
```
Month: September (month 9 of 12)
Expected pro-rata: 75%
Barrister at 60% progress:
- RAG Status: AMBER (60% < 70% threshold)
- Trajectory: BEHIND PACE (15 points below expected)
- Assessment: Needs intervention - may miss year-end target at current pace
```

**Service:** `chambers-insights-claude.service.server.ts`

```typescript
// Uses Anthropic SDK
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({
  apiKey: env.ANTHROPIC_API_KEY,
});

// Claude Sonnet 4 for complex reasoning
const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',
  max_tokens: 4096,
  messages: [{ role: 'user', content: prompt }],
});
```

**Token Costs (Claude Sonnet 4):**

| Type | Cost |
|------|------|
| Input | $3 per 1M tokens |
| Output | $15 per 1M tokens |

## OpenAI-Powered Features

### Lead Suggestions (`/api/ai/suggestions`)

Uses OpenAI GPT-4o-mini for fast, cost-effective barrister matching.

**Why OpenAI for Lead Suggestions?**

- Faster response times for interactive features
- More cost-effective for high-volume operations
- Excellent at structured matching tasks

**Service:** `suggestion-engine.server.ts`

```typescript
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: env.OPENAI_API_KEY,
});

const response = await openai.chat.completions.create({
  model: 'gpt-4o-mini',
  messages: [{ role: 'user', content: prompt }],
});
```

**Token Costs (GPT-4o-mini):**

| Type | Cost |
|------|------|
| Input | $0.15 per 1M tokens |
| Output | $0.60 per 1M tokens |

## Data Privacy

### Anonymization (All AI Calls)

All data sent to any AI provider is anonymized for GDPR compliance:

```typescript
class DataAnonymizer {
  anonymize(data: LeadData): AnonymizedData {
    return {
      practiceArea: data.practiceArea, // Kept
      jurisdiction: data.jurisdiction, // Kept
      valueRange: this.bucketValue(data.value), // Bucketed
      clientName: `CLIENT_${hash(data.clientName)}`, // Tokenized
      description: this.redactPII(data.description), // Redacted
    };
  }
}
```

### What Is NOT Sent to AI

<Warning>
The following data is never sent to AI providers:
</Warning>

- Client names (tokenized)
- Contact details (removed)
- Financial specifics (bucketed into ranges)
- Personal identifiable information
- Email addresses, phone numbers

### Data Retention

- **Anthropic (Claude)**: Does not retain API data for training
- **OpenAI**: API data not used for training (business tier)

## API Endpoints

### GET /api/ai/chambers-insights

Get daily strategic insights (Claude-powered).

**Access:** Management and Treasurer only

**Query Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| year | number | Year for data analysis |
| refresh | boolean | Force regeneration |
| webEnhanced | boolean | Include industry context |

**Response:**
```json
{
  "success": true,
  "financialRisk": {
    "severity": "moderate",
    "alerts": [...],
    "recommendations": [...]
  },
  "performanceTrends": {
    "growing": [...],
    "declining": [...]
  },
  "executiveSummary": "...",
  "metadata": {
    "model": "claude-sonnet-4",
    "processing_time_ms": 2500
  }
}
```

### POST /api/ai/suggestions

Get AI suggestions for lead assignment (OpenAI-powered).

**Request:**
```json
{
  "leadId": "uuid"
}
```

**Response:**
```json
{
  "suggestions": [
    {
      "barristerId": "uuid",
      "barristerName": "John Smith KC",
      "score": 0.92,
      "reasons": [
        "Specialises in Commercial Litigation",
        "Extensive experience in contract disputes",
        "Currently has capacity"
      ]
    }
  ],
  "metadata": {
    "model": "gpt-4o-mini",
    "processing_time_ms": 450
  }
}
```

### POST /api/ai/chambers-insights/query

Ask natural language questions about chambers analytics (Claude-powered).

**Request:**
```json
{
  "question": "Which barristers are behind their targets?",
  "context": "performance review",
  "year": 2025
}
```

**Response:**
```json
{
  "answer": "Based on trajectory analysis, 3 barristers are significantly behind pace...",
  "confidence": "high",
  "sources": [
    { "type": "financial", "description": "Barrister billing data" }
  ],
  "relatedInsights": ["Consider reviewing workload distribution"],
  "suggestedFollowUps": ["What practice areas have the most capacity?"],
  "metadata": {
    "ai_model": "claude-3-5-sonnet",
    "processing_time_ms": 1200
  }
}
```

### POST /api/ai/suggestions

Get AI suggestions for lead assignment (OpenAI-powered).

**Request:**
```json
{
  "leadId": "uuid"
}
```

## Usage Monitoring

### Tracking Usage

Monitor AI usage at `/admin/ai`:

- Daily request counts by provider
- Cost estimates (Claude vs OpenAI)
- Feature breakdown
- Error rates

### Usage Limits

| Limit | Value | Purpose |
|-------|-------|---------|
| Daily suggestions | 100 | Cost control (OpenAI) |
| Insights refresh | 1/day | Efficiency (Claude) |
| Batch size | 50 | Rate limiting |

### Cost Estimation

| Feature | Provider | ~Cost per call |
|---------|----------|---------------|
| Chamber insights | Claude | £0.10-0.30 |
| Lead suggestion | OpenAI | £0.01-0.03 |
| Analytics insight | OpenAI | £0.02-0.05 |

## Error Handling

### Provider-Specific Errors

**Claude (Anthropic):**

| Error | Cause | Solution |
|-------|-------|----------|
| `401` | Invalid API key | Check ANTHROPIC_API_KEY |
| `429` | Rate limited | Implement backoff |
| `overloaded` | High demand | Retry with delay |

**OpenAI:**

| Error | Cause | Solution |
|-------|-------|----------|
| `401` | Invalid API key | Check OPENAI_API_KEY |
| `429` | Rate limited | Implement backoff |
| `context_length` | Input too long | Reduce input size |

### Fallback Behavior

When AI is unavailable:

- **Lead suggestions**: Rule-based matching using specialisations
- **Chamber insights**: Show cached insights or skip
- **Analytics**: Basic statistical analysis

### Circuit Breaker

Both AI services use circuit breakers:

```typescript
const aiCircuitBreaker = new CircuitBreaker({
  failureThreshold: 3,
  resetTimeout: 60000, // 1 minute
});
```

## Configuration

### Environment Variables

```bash
# Required for Chamber Insights
ANTHROPIC_API_KEY=sk-ant-...

# Required for Lead Suggestions & Analytics
OPENAI_API_KEY=sk-...
```

### Feature Flags

Control AI features in Settings:

| Flag | Description | Provider |
|------|-------------|----------|
| `ai.insights.enabled` | Enable chamber insights | Claude |
| `ai.suggestions.enabled` | Enable lead suggestions | OpenAI |
| `ai.analytics.enabled` | Enable analytics AI | OpenAI |

## Best Practices

### Choosing the Right Provider

- **Complex reasoning tasks** - Claude (better analysis)
- **High-volume operations** - OpenAI (more cost-effective)
- **Interactive features** - OpenAI (faster response)
- **Strategic reports** - Claude (deeper insights)

### Cost Optimization

- Cache Claude responses (expensive but valuable)
- Use OpenAI for frequent, smaller requests
- Batch similar OpenAI requests
- Monitor usage at `/admin/ai`

### Security

- Never include PII in prompts to either provider
- Anonymize all client data before AI calls
- Audit AI usage regularly
- Review generated content before display

## Troubleshooting

### No Chamber Insights

1. Check `ANTHROPIC_API_KEY` is valid
2. Verify user has management/treasurer role
3. Check Anthropic service status
4. Review error logs

### No Lead Suggestions

1. Check `OPENAI_API_KEY` is valid
2. Verify AI suggestions are enabled
3. Check usage limits not exceeded
4. Review error logs

### Slow Responses

1. Check provider status pages (Anthropic/OpenAI)
2. Reduce context size
3. Consider caching more aggressively
4. Check if circuit breaker is open

## Service Files Reference

| Service | Provider | File |
|---------|----------|------|
| Chamber Insights | Claude | `chambers-insights-claude.service.server.ts` |
| Daily Cron Insights | Claude | `generate-daily-insights/+server.ts` |
| Natural Language Query | Claude | `chambers-insights/query/+server.ts` |
| Prompt Templates | Claude | `chambers-prompts-claude.ts` |
| Lead Suggestions | OpenAI | `suggestion-engine.server.ts` |
| Legacy Insights (unused) | OpenAI | `chambers-insights.service.server.ts` |

## Data Sources for AI Analytics

The AI aggregator gathers data from multiple sources for comprehensive analysis:

| Data Type | Source | Description |
|-----------|--------|-------------|
| Financial | `work_done_barrister_summaries` | Billing and revenue data |
| Targets | `financial_targets` | Annual targets and progress |
| Cash Flow | `bank_accounts`, `xero_financial_records` | Bank balances and invoices |
| YoY History | `work_done_barrister_summaries` (prev year) | Year-over-year comparisons |
| Leads | `leads`, `lead_assignments` | Lead funnel and conversions |
| Clients | `clients`, `client_barrister_relationships` | Client relationships and risk |
| Utilisation | `utilisation_entries` | Work type distribution |
| Website | `ga4_page_views` | Practice area traffic |
