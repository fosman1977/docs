---
title: "Tasks API"
description: "Technical reference for the Clerk Tasks feature including database schema, service methods, and real-time events"
---

This document provides technical details for developers working with the Tasks (Todos) feature, including database schema, TypeScript types, service methods, and integration points.

## Database Schema

### `clerk_todos` Table

The main table storing all task items.

```sql
CREATE TABLE clerk_todos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Core fields
    title TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'in_progress', 'completed')),
    priority TEXT NOT NULL DEFAULT 'medium'
        CHECK (priority IN ('low', 'medium', 'high', 'urgent')),
    category TEXT
        CHECK (category IN ('operations', 'case_related', 'admin', 'personal')),
    due_date DATE,

    -- Assignment
    assigned_to UUID REFERENCES users(id) ON DELETE SET NULL,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Completion tracking
    completed_at TIMESTAMPTZ,
    completed_by UUID REFERENCES users(id) ON DELETE SET NULL,

    -- Entity linking
    related_lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
    related_opportunity_id UUID REFERENCES opportunities(id) ON DELETE SET NULL,

    -- Metadata
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true
);
```

### Indexes

```sql
CREATE INDEX idx_clerk_todos_status ON clerk_todos(status);
CREATE INDEX idx_clerk_todos_assigned_to ON clerk_todos(assigned_to);
CREATE INDEX idx_clerk_todos_created_by ON clerk_todos(created_by);
CREATE INDEX idx_clerk_todos_due_date ON clerk_todos(due_date);
CREATE INDEX idx_clerk_todos_priority ON clerk_todos(priority);
```

### Row Level Security

```sql
-- Users can only see their own tasks or tasks assigned to them
CREATE POLICY "Users can view own tasks"
ON clerk_todos FOR SELECT
USING (
    auth.uid() = created_by
    OR auth.uid() = assigned_to
    OR EXISTS (
        SELECT 1 FROM user_roles
        WHERE user_id = auth.uid()
        AND role IN ('management', 'admin')
    )
);

-- Users can only modify their own tasks
CREATE POLICY "Users can modify own tasks"
ON clerk_todos FOR ALL
USING (auth.uid() = created_by);
```

## TypeScript Types

```typescript
interface ClerkTodo {
  id: string;
  title: string;
  description: string | null;
  status: 'pending' | 'in_progress' | 'completed';
  priority: 'low' | 'medium' | 'high' | 'urgent';
  category: 'operations' | 'case_related' | 'admin' | 'personal' | null;
  due_date: string | null;
  assigned_to: string | null;
  created_by: string;
  completed_at: string | null;
  completed_by: string | null;
  related_lead_id: string | null;
  related_opportunity_id: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
  is_active: boolean;
}

interface CreateTodoInput {
  title: string;
  description?: string;
  priority?: 'low' | 'medium' | 'high' | 'urgent';
  category?: 'operations' | 'case_related' | 'admin' | 'personal';
  due_date?: string;
  assigned_to?: string;
  related_lead_id?: string;
}

interface UpdateTodoInput {
  title?: string;
  description?: string;
  status?: 'pending' | 'in_progress' | 'completed';
  priority?: 'low' | 'medium' | 'high' | 'urgent';
  category?: 'operations' | 'case_related' | 'admin' | 'personal';
  due_date?: string;
  assigned_to?: string;
  related_lead_id?: string;
  notes?: string;
}
```

## API Endpoints

### List Tasks

```
GET /api/todos
```

**Query Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `status` | string | Filter by status |
| `priority` | string | Filter by priority |
| `category` | string | Filter by category |
| `due_before` | string | Due date before (ISO) |
| `due_after` | string | Due date after (ISO) |
| `search` | string | Search title/description |

**Response:**

```json
{
  "data": [
    {
      "id": "uuid",
      "title": "Follow up with client",
      "status": "pending",
      "priority": "high",
      "due_date": "2025-12-26",
      "created_at": "2025-12-25T10:00:00Z"
    }
  ],
  "count": 25
}
```

### Create Task

```
POST /api/todos
```

**Request Body:**

```json
{
  "title": "Review contract",
  "description": "Review updated terms",
  "priority": "high",
  "category": "case_related",
  "due_date": "2025-12-30",
  "related_lead_id": "uuid"
}
```

### Update Task

```
PUT /api/todos/:id
```

**Request Body:**

```json
{
  "status": "completed",
  "notes": "Completed review, sent to client"
}
```

### Delete Task

```
DELETE /api/todos/:id
```

## TodoService API

The `TodoService` class provides all CRUD operations.

```typescript
class TodoService {
  // List todos with filters
  async list(filters: TodoFilters): Promise<ClerkTodo[]>

  // Get single todo
  async get(id: string): Promise<ClerkTodo | null>

  // Create new todo
  async create(input: CreateTodoInput): Promise<ClerkTodo>

  // Update todo
  async update(id: string, input: UpdateTodoInput): Promise<ClerkTodo>

  // Delete todo (soft delete)
  async delete(id: string): Promise<void>

  // Update status only
  async updateStatus(id: string, status: TodoStatus): Promise<ClerkTodo>

  // Get todos for a specific user
  async getByUser(userId: string): Promise<ClerkTodo[]>

  // Get overdue todos
  async getOverdue(): Promise<ClerkTodo[]>
}
```

## Real-Time Events

Tasks integrate with Socket.io for live updates.

### Events

| Event | Direction | Description |
|-------|-----------|-------------|
| `todo:created` | Server → Client | New task created |
| `todo:updated` | Server → Client | Task updated |
| `todo:deleted` | Server → Client | Task deleted |
| `todo:status_changed` | Server → Client | Status changed |

### Event Payloads

```typescript
// todo:created
{
  todo: ClerkTodo,
  createdBy: { id: string, name: string }
}

// todo:updated
{
  todo: ClerkTodo,
  updatedBy: { id: string, name: string },
  changes: string[] // fields that changed
}

// todo:status_changed
{
  todoId: string,
  previousStatus: string,
  newStatus: string,
  changedBy: { id: string, name: string }
}
```

### Subscribing to Events

```typescript
import { io } from 'socket.io-client';

const socket = io('/api/socket');

socket.on('todo:created', (data) => {
  console.log('New todo:', data.todo);
});

socket.on('todo:status_changed', (data) => {
  console.log(`Todo ${data.todoId} changed to ${data.newStatus}`);
});
```

## UI Components

| Component | Path | Purpose |
|-----------|------|---------|
| `TodoList` | `$lib/components/features/todos/TodoList.svelte` | List view with tabs |
| `TodoKanban` | `$lib/components/features/todos/TodoKanban.svelte` | Kanban board view |
| `TodoItem` | `$lib/components/features/todos/TodoItem.svelte` | Individual task row |
| `TodoCreateModal` | `$lib/components/features/todos/TodoCreateModal.svelte` | Create/edit modal |
| `TodoFilterBar` | `$lib/components/features/todos/TodoFilterBar.svelte` | Filter controls |

## Integration Points

### With Leads

Tasks can be linked to leads via `related_lead_id`:

```typescript
const task = await todoService.create({
  title: 'Follow up on lead',
  related_lead_id: leadId,
  priority: 'high'
});
```

### With Opportunities

Tasks can be linked to opportunities via `related_opportunity_id`:

```typescript
const task = await todoService.create({
  title: 'Prepare for meeting',
  related_opportunity_id: opportunityId
});
```

## Audit Logging

Task operations are logged to the audit system:

| Event | Description |
|-------|-------------|
| `todo.created` | Task created |
| `todo.updated` | Task modified |
| `todo.completed` | Task marked complete |
| `todo.deleted` | Task deleted |
